{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "commonSettings": {
            "type": "object",
            "metadata": {
                "Description": "Common settings object"
            }
        },
        "networkSettings": {
            "type": "object",
            "metadata": {
                "Description": "Network settings object"
            }
        },
        "machineSettings": {
            "type": "object",
            "metadata": {
                "Description": "Machine settings object"
            }
        },
        "storageAccountNamePrefix": {
            "type": "string",
            "defaultValue": "uniquestorageAccountNamePrefix",
            "metadata": {
                "Description": "Unique namespace for the Storage Account where the Virtual Machine's disks will be placed"
            }
        }
    },
    "variables": {
        "vmStorageAccountContainerName": "vhd",
        "winSourceImageName": "[concat('/',subscription().subscriptionId,'/services/images/a699494373c04fc0bc8f2bb1389d6106__Windows-Server-Technical-Preview-201504.01-en.us-127GB.vhd')]",
        "jbSubnetRef": "[concat(resourceId('Microsoft.Network/virtualNetworks',parameters('networkSettings').virtualNetworkName),'/subnets/jbsubnet')]",
        "storageAccountName": "[concat(parameters('storageAccountNamePrefix'), 'jb')]"
    },
    "resources": [{
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Network/virtualNetworks",
        "name": "vnetJbsubnet",
        "location": "[parameters('commonSettings').region]",
        "properties": {
            "addressSpace": {
                "addressPrefixes": [
                    "[parameters('networkSettings').addressPrefix]"
                ]
            },
            "subnets": [{
                "name": "jbsubnet",
                "properties": {
                    "addressPrefix": "10.0.10.0/29"
                }
            }]
        }
    }, {
        "type": "Microsoft.Storage/storageAccounts",
        "name": "[variables('storageAccountName')]",
        "apiVersion": "2015-05-01-preview",
        "location": "[parameters('commonSettings').region]",
        "properties": {
            "accountType": "Standard_LRS"
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "publicIP",
        "location": "[parameters('commonSettings').region]",
        "properties": {
            "publicIPAllocationMethod": "Dynamic"
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "nicJumpbox",
        "location": "[parameters('commonSettings').region]",
        "dependsOn": [
            "[concat('Microsoft.Network/publicIPAddresses/', 'publicIP')]",
            "vnetJbsubnet"
        ],
        "properties": {
            "ipConfigurations": [{
                "name": "ipconfig1",
                "properties": {
                    "privateIPAllocationMethod": "Dynamic",
                    "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses','publicIP')]"
                    },
                    "subnet": {
                        "id": "[variables('jbSubnetRef')]"
                    }
                }
            }]
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "jumpbox",
        "location": "[parameters('commonSettings').region]",
        "dependsOn": [
            "[concat('Microsoft.Network/networkInterfaces/', 'nicJumpbox')]",
            "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"
        ],
        "properties": {
            "hardwareProfile": {
                "vmSize": "Standard_A0",
                "platformGuestAgent": "true"
            },
            "osProfile": {
                "computername": "[concat(parameters('machineSettings').machineNamePrefix, 'jumpbox')]",
                "adminUsername": "[parameters('machineSettings').adminUsername]",
                "adminPassword": "[parameters('machineSettings').adminPassword]",
                "linuxOperatingSystemProfile": {
                    "disableSshPasswordAuthentication": "false"
                }
            },
            "storageProfile": {
                "imageReference": "[parameters('machineSettings').imageReference]",
                "destinationVhdsContainer": "[concat('https://' ,variables('storageAccountName'), '.blob.core.windows.net/',variables('vmStorageAccountContainerName'),'/')]"
            },
            "networkProfile": {
                "networkInterfaces": [{
                    "id": "[resourceId('Microsoft.Network/networkInterfaces','nicJumpbox')]"
                }],
                "inputEndpoints": [{
                    "enableDirectServerReturn": "False",
                    "endpointName": "SSH",
                    "privatePort": 22,
                    "publicPort": 22,
                    "protocol": "tcp"
                }]
            }
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "publicIPWin",
        "location": "[parameters('commonSettings').region]",
        "properties": {
            "publicIPAllocationMethod": "Dynamic"
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "nicWin",
        "location": "[parameters('commonSettings').region]",
        "dependsOn": [
            "[concat('Microsoft.Network/publicIPAddresses/', 'publicIPWin')]",
            "vnetJbsubnet"
        ],
        "properties": {
            "ipConfigurations": [{
                "name": "ipconfig1",
                "properties": {
                    "privateIPAllocationMethod": "Dynamic",
                    "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses','publicIPWin')]"
                    },
                    "subnet": {
                        "id": "[variables('jbSubnetRef')]"
                    }
                }
            }]
        }
    }, {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "windows",
        "location": "[parameters('commonSettings').region]",
        "dependsOn": [
            "[concat('Microsoft.Network/networkInterfaces/', 'nicWin')]",
            "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"
        ],
        "properties": {
            "hardwareProfile": {
                "vmSize": "Standard_A1",
                "platformGuestAgent": "true"
            },
            "osProfile": {
                "computername": "[concat(parameters('machineSettings').machineNamePrefix, 'win')]",
                "adminUsername": "[parameters('machineSettings').adminUsername]",
                "adminPassword": "[parameters('machineSettings').adminPassword]",
                "linuxOperatingSystemProfile": {
                    "disableSshPasswordAuthentication": "false"
                }
            },
            "storageProfile": {
                "sourceImage": {
                    "id": "[variables('winSourceImageName')]"
                },
                "destinationVhdsContainer": "[concat('https://' ,variables('storageAccountName'), '.blob.core.windows.net/',variables('vmStorageAccountContainerName'),'/')]"
            },
            "networkProfile": {
                "networkInterfaces": [{
                    "id": "[resourceId('Microsoft.Network/networkInterfaces','nicWin')]"
                }],
                "inputEndpoints": [{
                    "enableDirectServerReturn": "False",
                    "endpointName": "RDP",
                    "privatePort": 3389,
                    "publicPort": 3389,
                    "protocol": "tcp"
                }]
            }
        }
    }],
    "outputs": {}
}